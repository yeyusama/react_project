<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
  </head>
  <body>
    <button id="btn1">--按钮--</button>
    <button id="btn2">--按钮--</button>
    <button id="btn3">--按钮--</button>
    <script src="https://cdn.bootcss.com/axios/0.19.0/axios.min.js"></script>
    <script>
      const btn1 = document.querySelector("#btn1");
      const btn2 = document.querySelector("#btn2");
      const btn3 = document.querySelector("#btn3");

      let token =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjVkZDMzZGJjYmVhM2UzZTA3NDBhYTZmNCIsImlhdCI6MTU3NDIzMTg5OCwiZXhwIjoxNTc0ODM2Njk4fQ.3969d9u1wbcmZ026Tec21cXYyEYUb9oemaE0BIG7ikE";

      const axiosInstance = axios.create({
        baseURL: "http://localhost:5000/api",
        timeout: 10000,
        headers: {}
      });

      axiosInstance.interceptors.request.use(config => {
        if (config.method === "post") {
          config.headers["content-type"] = "application/x-www-form-urlencoded";

          config.data = Object.keys(config.data)
            .reduce((prev, key) => {
              const value = config.data[key];
              return prev + `&${key}=${value}`;
            }, "")
            .substring(1);
        }

        if (token) {
          config.headers.authorization = "Bearer " + token;
        }
        return config;
      });
      axiosInstance.interceptors.response.use(
        response => {
          if (response.data.status === 0) {
            return response.data.data;
          } else {
            alert(response.data.msg);
            return Promise.reject(response.data.msg);
          }
        },
        error => {
          const codeMessage = {
            401: "请确认你的权限",
            403: "此网页已被禁止访问",
            404: "你要访问的资源不存在",
            500: "哇哦，你的电脑炸了！请更换电脑~~"
          };

          let errorMessage = "";

          if (error.response) {
            errorMessage = codeMessage[error.response.status] || "未知错误";
          } else {
            if (error.message.indexOf("Network Error") !== -1) {
              errorMessage = "请检查网络连接";
            } else if (error.message.indexOf("timeout") !== -1) {
              errorMessage = "网络太卡了，请连上wifi重试";
            } else {
              errorMessage = "未知错误";
            }
          }
          // console.dir(error);
          alert(errorMessage);
          return Promise.reject(errorMessage);
        }
      );

      btn1.onclick = function() {
        // 发送请求
        /*
        在axios中默认post请求的content-type是application/json
        但是，有可能公司要求content-type用application/x-www-form-urlencoded
      */
        axiosInstance({
          method: "POST",
          url: "/login",
          data: {
            username: "admin",
            password: "admin"
          }
          // data: 'username=admin&password=admin',
          /* headers: {
            'content-type': 'application/x-www-form-urlencoded'
          } */
        }).then(response => {
          console.log(response.token);
          token = response.token;
        });
      };

      btn2.onclick = function() {
        axiosInstance({
          method: "GET",
          url: "/category/get"
          /* headers: {
            authorization: 'Bearer ' + token
          } */
        }).then(response => {
          console.log(response);
        });
      };

      btn3.onclick = function() {
        axiosInstance({
          method: "POST",
          url: "/category/add",
          // data: 'categoryName=鼠标',
          data: {
            categoryName: "鼠标"
          },
          headers: {
            // 'content-type': 'application/x-www-form-urlencoded',
            // authorization: 'Bearer ' + token
          }
        }).then(response => {
          console.log(response);
        });
      };
    </script>
  </body>
</html>
